# Auto-merge Dependabot PRs after CI passes.
#
# Flow:
#   1. Dependabot opens a PR → CI workflow runs build+lint
#   2. When CI completes, this workflow triggers via workflow_run
#   3. If CI passed AND the PR is from Dependabot AND it's a safe update
#      (patch/minor/actions), the PR is merged automatically
#   4. Major npm version bumps are NOT auto-merged — they require manual review
#
# This approach avoids branch protection/rulesets entirely, which would block
# the GITHUB_TOKEN direct pushes used by automation workflows (auto-blog,
# auto-fortunes, auto-horoscopes, auto-seasonal).
name: Dependabot auto-merge

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'

    steps:
      - name: Find the Dependabot PR
        id: pr
        run: |
          # Find the PR matching the workflow run's head SHA
          PR_NUMBER=$(gh api "repos/$REPO/pulls?state=open&head=dependabot" \
            --jq "[.[] | select(.head.sha == \"$HEAD_SHA\")] | first | .number // empty")

          if [ -z "$PR_NUMBER" ]; then
            echo "No open Dependabot PR found for SHA $HEAD_SHA"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TITLE=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json title --jq '.title')
          echo "Found PR #$PR_NUMBER: $TITLE"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "found=true" >> "$GITHUB_OUTPUT"
        env:
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge safe updates
        if: steps.pr.outputs.found == 'true'
        run: |
          TITLE="${PR_TITLE}"

          # Auto-merge conditions (safe updates only):
          # 1. GitHub Actions bumps: "Bump actions/..." or "Bump the actions group"
          # 2. Grouped minor/patch: "Bump the minor-and-patch group..."
          # 3. Single patch/minor: titles like "Bump X from 1.2.3 to 1.2.4" or "1.2.3 to 1.3.0"
          #    (major bumps have different first digit: "from 1.x to 2.x")

          if echo "$TITLE" | grep -qiE "^Bump (actions/|the (actions|minor-and-patch) group)"; then
            echo "Safe update (Actions or grouped minor/patch). Merging PR #$PR_NUMBER..."
            gh pr merge "$PR_NUMBER" --repo "$REPO" --merge
            exit 0
          fi

          # For single-package bumps, extract version numbers and compare major versions
          FROM_VER=$(echo "$TITLE" | grep -oP 'from \K[0-9]+' | head -1)
          TO_VER=$(echo "$TITLE" | grep -oP 'to \K[0-9]+' | head -1)

          if [ -n "$FROM_VER" ] && [ -n "$TO_VER" ]; then
            if [ "$FROM_VER" = "$TO_VER" ]; then
              echo "Same major version ($FROM_VER → $TO_VER). Merging PR #$PR_NUMBER..."
              gh pr merge "$PR_NUMBER" --repo "$REPO" --merge
              exit 0
            else
              echo "Major version bump ($FROM_VER → $TO_VER). Skipping — requires manual review."
              exit 0
            fi
          fi

          echo "Could not determine update type from title. Skipping auto-merge."
        env:
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
