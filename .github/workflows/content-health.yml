name: Content Health Check

on:
  schedule:
    - cron: "0 12 * * 1" # Monday noon UTC
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  content-health:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Check blog freshness
        id: freshness
        run: |
          echo "Checking blog post freshness..."
          RECENT=$(git log --since="14 days ago" --name-only --pretty=format: -- "src/content/blog/*.mdx" | grep -c ".mdx" || echo "0")
          echo "Posts added/modified in last 14 days: $RECENT"
          if [ "$RECENT" -lt 2 ]; then
            echo "::warning::Less than 2 blog posts in the last 14 days. Auto-blog pipeline may have stopped."
            echo "BLOG_STALE=true" >> $GITHUB_ENV
          else
            echo "Blog freshness OK ($RECENT posts in 14 days)"
            echo "BLOG_STALE=false" >> $GITHUB_ENV
          fi

      - name: Trigger auto-blog if stale
        if: env.BLOG_STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-blog.yml',
              ref: 'main'
            });
            console.log('Triggered auto-blog workflow due to stale content');

      - name: Check horoscope freshness
        run: |
          echo "Checking horoscope freshness..."
          DATE=$(node -e "const d=JSON.parse(require('fs').readFileSync('src/data/horoscopes.json','utf8'));console.log(d.daily.date)")
          NOW=$(date +%s)
          THEN=$(date -d "$DATE" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$DATE" +%s 2>/dev/null || echo "0")
          if [ "$THEN" = "0" ]; then
            echo "::warning::Could not parse horoscope date: $DATE"
            echo "HOROSCOPE_STALE=true" >> $GITHUB_ENV
          else
            DAYS_OLD=$(( (NOW - THEN) / 86400 ))
            echo "Daily horoscope date: $DATE ($DAYS_OLD days old)"
            if [ "$DAYS_OLD" -gt 2 ]; then
              echo "::warning::Horoscope data is ${DAYS_OLD} days old"
              echo "HOROSCOPE_STALE=true" >> $GITHUB_ENV
            else
              echo "Horoscope freshness OK"
              echo "HOROSCOPE_STALE=false" >> $GITHUB_ENV
            fi
          fi

      - name: Trigger auto-horoscopes if stale
        if: env.HOROSCOPE_STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-horoscopes.yml',
              ref: 'main'
            });
            console.log('Triggered auto-horoscopes workflow due to stale content');

      - name: Check fortune freshness
        run: |
          echo "Checking fortune freshness..."
          RECENT=$(git log --since="14 days ago" --name-only --pretty=format: -- "src/data/fortunes.json" | grep -c "fortunes.json" || echo "0")
          echo "Fortune file changes in last 14 days: $RECENT"
          if [ "$RECENT" -lt 1 ]; then
            echo "::warning::No fortune updates in 14 days. Auto-fortunes pipeline may have stopped."
            echo "FORTUNE_STALE=true" >> $GITHUB_ENV
          else
            echo "Fortune freshness OK"
            echo "FORTUNE_STALE=false" >> $GITHUB_ENV
          fi

      - name: Trigger auto-fortunes if stale
        if: env.FORTUNE_STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-fortunes.yml',
              ref: 'main'
            });
            console.log('Triggered auto-fortunes workflow due to stale content');

      - name: Validate content integrity
        run: npx tsx scripts/validate-content.ts

      - name: Verify key pages
        run: |
          PAGES=(
            "https://fortunecrack.com"
            "https://fortunecrack.com/blog"
            "https://fortunecrack.com/daily"
            "https://fortunecrack.com/lucky-numbers"
            "https://fortunecrack.com/fortune/wisdom"
            "https://fortunecrack.com/zodiac/aries"
            "https://fortunecrack.com/horoscope"
            "https://fortunecrack.com/horoscope/daily/aries"
            "https://fortunecrack.com/horoscope/weekly/leo"
          )
          FAILED=0
          for url in "${PAGES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "OK: $url ($STATUS)"
            else
              echo "::error::FAIL: $url (HTTP $STATUS)"
              FAILED=1
            fi
          done
          if [ "$FAILED" = "1" ]; then
            exit 1
          fi

  notify-failure:
    needs: content-health
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Content health check failed';
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated',
              per_page: 10
            });
            if (!existing.data.some(i => i.title === title)) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `Workflow run failed: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                labels: ['bug', 'automated']
              });
            }

  notify-success:
    needs: content-health
    if: success()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const titles = [
              'ðŸš¨ Content health check failed',
              'ðŸš¨ Auto-blog pipeline failed',
              'ðŸš¨ Auto-fortunes pipeline failed',
              'ðŸš¨ Auto-horoscopes pipeline failed'
            ];
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated',
              per_page: 30
            });
            for (const issue of issues.data) {
              if (titles.includes(issue.title)) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `âœ… Content health check passed â€” all pipelines recovered. Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
              }
            }
