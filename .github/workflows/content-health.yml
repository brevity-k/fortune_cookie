name: Content Health Check

on:
  schedule:
    - cron: "0 12 * * 1" # Monday noon UTC
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  content-health:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check blog freshness
        id: freshness
        run: |
          echo "Checking blog post freshness..."
          RECENT=$(git log --since="14 days ago" --name-only --pretty=format: -- "src/content/blog/*.mdx" | grep -c ".mdx" || echo "0")
          echo "Posts added/modified in last 14 days: $RECENT"
          if [ "$RECENT" -lt 2 ]; then
            echo "::warning::Less than 2 blog posts in the last 14 days. Auto-blog pipeline may have stopped."
            echo "BLOG_STALE=true" >> $GITHUB_ENV
          else
            echo "Blog freshness OK ($RECENT posts in 14 days)"
            echo "BLOG_STALE=false" >> $GITHUB_ENV
          fi

      - name: Trigger auto-blog if stale
        if: env.BLOG_STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-blog.yml',
              ref: 'main'
            });
            console.log('Triggered auto-blog workflow due to stale content');

      - name: Verify key pages
        run: |
          PAGES=(
            "https://fortunecrack.com"
            "https://fortunecrack.com/blog"
            "https://fortunecrack.com/daily"
            "https://fortunecrack.com/lucky-numbers"
            "https://fortunecrack.com/fortune/wisdom"
            "https://fortunecrack.com/zodiac/aries"
          )
          FAILED=0
          for url in "${PAGES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "OK: $url ($STATUS)"
            else
              echo "::error::FAIL: $url (HTTP $STATUS)"
              FAILED=1
            fi
          done
          if [ "$FAILED" = "1" ]; then
            exit 1
          fi

  notify-failure:
    needs: content-health
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Content health check failed',
              body: `Workflow run failed: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'automated']
            });
